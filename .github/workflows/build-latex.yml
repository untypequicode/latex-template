name: Construction des projets LaTeX (dynamique, par-projet latex.build)

on:
  push:
    branches: [main, master]
    paths:
      - "src/**"
      - ".github/workflows/build-latex-dynamic-config.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "src/**"
      - ".github/workflows/build-latex-dynamic-config.yml"
  workflow_dispatch:

jobs:
  prepare:
    name: Préparer la matrice
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.find.outputs.matrix }}
    steps:
      - name: Récupérer le dépôt
        uses: actions/checkout@v4

      - name: Rechercher les fichiers latex.build
        id: find
        shell: bash
        run: |
          echo "Recherche de fichiers latex.build sous src/ ..."
          # Rechercher les fichiers nommés latex.build sous src/ (un par projet LaTeX)
          mapfile -t files < <(find src -type f -name 'latex.build' -print)
          if [ ${#files[@]} -eq 0 ]; then
            echo "Aucun fichier latex.build trouvé."
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          includes=""
          first=true

          for f in "${files[@]}"; do
            dir=$(dirname "$f")

            # charger la configuration pour obtenir les variables (fichier au format shell simple)
            # variables attendues (optionnel) : justfile, output, just_target
            unset justfile output just_target
            # shellcheck disable=SC1090
            . "$f"

            # valeurs par défaut
            jf="${justfile:-justfile}"
            out="${output:-main.pdf}"
            jt="${just_target:-}"

            # échapper les valeurs pour JSON (échapper les guillemets doubles et les antislashs)
            esc() {
              printf '%s' "$1" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()).strip("\""))'
            }

            jf_esc=$(esc "$jf")
            out_esc=$(esc "$out")
            jt_esc=$(esc "$jt")
            dir_esc=$(esc "$dir")

            if [ "$first" = true ]; then
              includes="{\"project\":\"$dir_esc\",\"justfile\":\"$jf_esc\",\"output\":\"$out_esc\",\"just_target\":\"$jt_esc\"}"
              first=false
            else
              includes="$includes,{\"project\":\"$dir_esc\",\"justfile\":\"$jf_esc\",\"output\":\"$out_esc\",\"just_target\":\"$jt_esc\"}"
            fi
          done

          matrix="{\"include\":[$includes]}"
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build:
    name: Build LaTeX projects
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Récupérer le dépôt
        uses: actions/checkout@v4

      - name: Installer TeX Live (minimal) et utilitaires
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-lang-french \
            lmodern \
            python3
      - name: Show project info
        run: |
          echo "Répertoire du projet : ${{ matrix.project }}"
          echo "Justfile : ${{ matrix.justfile }}"
          echo "PDF de sortie attendu : ${{ matrix.output }}"
          if [ -n "${{ matrix.just_target }}" ]; then
            echo "Cible just : ${{ matrix.just_target }}"
          fi

      - name: Construire avec just (ou repli)
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -euo pipefail
          out="${{ matrix.output }}"
          jf="${{ matrix.justfile }}"
          jt="${{ matrix.just_target }}"

          echo "Répertoire de travail : $(pwd)"
          echo "Utilisation du justfile : $jf"
          echo "Sortie attendue : $out"

          if command -v just >/dev/null 2>&1; then
            if [ -n "$jt" ]; then
              echo "Exécution : just -f \"$jf\" \"$jt\""
              just -f "$jf" "$jt"
            else
              echo "Exécution : just -f \"$jf\""
              just -f "$jf"
            fi
          else
            echo "just introuvable. Repli sur une construction basée sur pdflatex."

            # Tenter de construire à partir d'un .tex dont le nom de base correspond au PDF de sortie
            base="${out%.*}.tex"
            if [ -f "$base" ]; then
              pdflatex -interaction=nonstopmode -halt-on-error "$base"
              pdflatex -interaction=nonstopmode -halt-on-error "$base"
            elif [ -f main.tex ]; then
              pdflatex -interaction=nonstopmode -halt-on-error main.tex
              pdflatex -interaction=nonstopmode -halt-on-error main.tex
            else
              echo "Pas de just et aucun point d'entrée .tex évident trouvé (essayé $base et main.tex)."
              # Échouer le job pour ce projet
              exit 1
            fi
          fi

      - name: Vérifier l'existence de la sortie
        working-directory: ${{ matrix.project }}
        run: |
          if [ -f "${{ matrix.output }}" ]; then
            echo "Sortie trouvée : ${{ matrix.output }}"
            ls -lh "${{ matrix.output }}"
          else
            echo "Sortie attendue introuvable : ${{ matrix.output }}"
            exit 1
          fi

      - name: Téléverser l'artefact PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-pdf
          path: ${{ matrix.project }}/${{ matrix.output }}
          retention-days: 90
