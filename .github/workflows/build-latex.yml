name: Construction des projets LaTeX (optimisé)

on:
  push:
    branches: [main, master]
    paths:
      - "**/*.tex"
      - "**/*.sty"
      - "**/latex.build"
      - "**/justfile*"
      - ".github/workflows/build-latex.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "**/*.tex"
      - "**/*.sty"
      - "**/latex.build"
      - "**/justfile*"
      - ".github/workflows/build-latex.yml"
  workflow_dispatch:

jobs:
  prepare:
    name: Préparer la matrice
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.find.outputs.matrix }}
    steps:
      - name: Récupérer le dépôt
        uses: actions/checkout@v4

      - name: Rechercher les fichiers latex.build
        id: find
        shell: bash
        run: |
          echo "Recherche de fichiers latex.build dans tout le dépôt..."
          mapfile -t files < <(find . -type f -name 'latex.build' -print)
          if [ ${#files[@]} -eq 0 ]; then
            echo "Aucun fichier latex.build trouvé."
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          includes=""
          first=true

          for f in "${files[@]}"; do
            dir=$(dirname "$f")

            unset justfile output just_target
            # shellcheck disable=SC1090
            . "$f"

            jf="${justfile:-justfile}"
            out="${output:-main.pdf}"
            jt="${just_target:-}"

            esc() {
              printf '%s' "$1" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()).strip("\""))'
            }

            jf_esc=$(esc "$jf")
            out_esc=$(esc "$out")
            jt_esc=$(esc "$jt")
            dir_esc=$(esc "$dir")

            if [ "$first" = true ]; then
              includes="{\"project\":\"$dir_esc\",\"justfile\":\"$jf_esc\",\"output\":\"$out_esc\",\"just_target\":\"$jt_esc\"}"
              first=false
            else
              includes="$includes,{\"project\":\"$dir_esc\",\"justfile\":\"$jf_esc\",\"output\":\"$out_esc\",\"just_target\":\"$jt_esc\"}"
            fi
          done

          matrix="{\"include\":[$includes]}"
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build:
    name: Build LaTeX projects
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Récupérer le dépôt
        uses: actions/checkout@v4

      - name: Installer TinyTeX (cache inclus)
        uses: r-lib/actions/setup-tinytex@v2
        env:
          TINYTEX_INSTALLER: TinyTeX

      - name: Installer just (si nécessaire)
        run: |
          if [ -f "${{ matrix.project }}/${{ matrix.justfile }}" ]; then
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          fi

      - name: Cache des packages LaTeX
        uses: actions/cache@v4
        with:
          path: ~/texmf
          key: latex-packages-${{ runner.os }}-${{ hashFiles('**/*.tex') }}
          restore-keys: |
            latex-packages-${{ runner.os }}-

      - name: Afficher les infos du projet
        run: |
          echo "Répertoire du projet : ${{ matrix.project }}"
          echo "Justfile : ${{ matrix.justfile }}"
          echo "PDF de sortie attendu : ${{ matrix.output }}"
          if [ -n "${{ matrix.just_target }}" ]; then
            echo "Cible just : ${{ matrix.just_target }}"
          fi

      - name: Construire avec just (ou repli)
        working-directory: ${{ matrix.project }}
        shell: bash
        run: |
          set -euo pipefail
          out="${{ matrix.output }}"
          jf="${{ matrix.justfile }}"
          jt="${{ matrix.just_target }}"

          echo "Répertoire de travail : $(pwd)"
          echo "Utilisation du justfile : $jf"
          echo "Sortie attendue : $out"

          if command -v just >/dev/null 2>&1 && [ -f "$jf" ]; then
            if [ -n "$jt" ]; then
              echo "Exécution : just -f \"$jf\" \"$jt\""
              just -f "$jf" "$jt"
            else
              echo "Exécution : just -f \"$jf\""
              just -f "$jf"
            fi
          else
            echo "just introuvable ou justfile absent. Repli sur pdflatex."

            base="${out%.*}.tex"
            if [ -f "$base" ]; then
              pdflatex -interaction=nonstopmode -halt-on-error "$base"
              pdflatex -interaction=nonstopmode -halt-on-error "$base"
            elif [ -f main.tex ]; then
              pdflatex -interaction=nonstopmode -halt-on-error main.tex
              pdflatex -interaction=nonstopmode -halt-on-error main.tex
            else
              echo "Aucun point d'entrée .tex trouvé (essayé $base et main.tex)."
              exit 1
            fi
          fi

      - name: Vérifier l'existence de la sortie
        working-directory: ${{ matrix.project }}
        run: |
          if [ -f "${{ matrix.output }}" ]; then
            echo "Sortie trouvée : ${{ matrix.output }}"
            ls -lh "${{ matrix.output }}"
          else
            echo "Sortie attendue introuvable : ${{ matrix.output }}"
            exit 1
          fi

      - name: Nettoyer le nom du projet pour l'artifact
        id: clean-name
        run: |
          # Remplacer les caractères invalides par des tirets
          clean_name=$(echo "${{ matrix.project }}" | sed 's/[\/\.\:]/-/g' | sed 's/^-*//' | sed 's/-*$//')
          echo "name=${clean_name}-pdf" >> $GITHUB_OUTPUT
          echo "Nom nettoyé : ${clean_name}-pdf"

      - name: Téléverser l'artefact PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.clean-name.outputs.name }}
          path: ${{ matrix.project }}/${{ matrix.output }}
          retention-days: 90
